# 小说生成平台 - 需求与技术方案(统一技术栈版)

本方案基于以下文件的综合分析与落地实现:
- 小说元素提取与再生.md
- 星矢的字段拼凑和公式生成和演化逻辑
- 智能拼接功能说明.md
- 向量段落库和剧情公式用来生成小说

并严格遵循项目统一规范(FastAPI + PostgreSQL/pgvector + sse_starlette + 最小依赖 + LRU/Redis缓存).

## 1. 功能目标
1) 拆书工具:
- 输入文本按语义单元拆分为段落;
- 对每个段落进行向量化(默认1536维,text-embedding-3-small);
- 段落存入向量段落库(Postgres + pgvector),建立检索索引;
- 段落携带结构化元信息(book/chapter/section/index、meta标签).

2) 智能拼接:
- 公式解析引擎(JSON/简易DSL),解析为检索计划;
- 根据计划对向量段落库进行匹配与排序;
- 将匹配段落按逻辑顺序拼接流式输出(SSE);
- 质量评估(占位,后续可引入连贯性评分、多样性约束等).

3) 统一技术栈:
- 后端:FastAPI + Uvicorn;数据库:Postgres + pgvector;
- AI:OpenAI兼容接口统一抽象(Responses/Embeddings);
- SSE:仅用 sse_starlette.EventSourceResponse;
- 缓存:标准库 lru_cache 或 aioredis,无额外依赖;
- 前端:React + TypeScript + Vite(原生 EventSource 客户端).

4) 交付成果:
- 技术架构设计与接口规范;
- 核心算法流程图与实现说明;
- 数据库ER图与索引设计;
- 性能测试方案与优化建议.

## 2. 架构设计
- services/ai_service.py:统一AI接口,新增 get_embeddings(1536/3072维);
- services/db_service.py:新增 Paragraph/Formula 模型与CRUD,创建 HNSW/IVFFlat 向量索引;
- services/paragraph_service.py:语义段落拆分、批量嵌入与入库;
- services/formula_engine.py:公式解析为检索计划、调用向量检索、排序与过滤;
- routers/story.py:拆书入库、公式管理与智能拼接流式输出(SSE).

## 3. 数据库ER图(文字版)
- documents(id, title, content, content_type, source, doc_metadata, embedding[float], embedding_model, created_at, updated_at, is_active)
- paragraphs(id, book_id, chapter_index, section_index, paragraph_index, content, meta, embedding[float], embedding_model, created_at, updated_at, is_active)
- formulas(id, name, category, description, expression, parameters, embedding[float], embedding_model, created_at, updated_at, is_active)
- vector_indexes(id, table_name, column_name, index_type, index_params, dimension, distance_metric, created_at, is_active)

索引:
- HNSW(m=16, ef_construction=64)或 IVFFlat(lists=100),度量:cosine;
- paragraphs.embedding 上创建 hnsw/ivfflat;
- documents.embedding 维持现有索引.

## 4. API接口规范(后端)
- POST /api/story/ingest
  - body: { text: string, bookId?: string, chapterIndex?: number, sectionIndex?: number, embeddingModel?: string }
  - resp: { code, message, data: { count, ids[] } }

- POST /api/story/formulas
  - body: { id?, name, expression, category?, description?, parameters? }
  - resp: { code, message, data: { id } }

- GET /api/story/formulas?category=...
  - resp: { code, message, data: Formula[] }

- POST /api/story/generate/stream (SSE)
  - body: { formula: string(JSON/DSL), prompt?: string }
  - events:
    - step { msg }
    - append { paragraph, similarity }
    - complete { count }
    - error { code, message }

错误处理:REST返回 {code, message};SSE 使用 event:error + data:{code, message}.

## 5. 核心流程(算法)
1) 拆书:
- 文本 -> 标准化 -> 空行初分 -> 句子聚合(最小长度) -> 超长二次拆分(最大长度) -> 清洗去重;
- 调用 get_embeddings 批量向量化(64/批),写入 paragraphs 表;

2) 智能拼接:
- 解析公式(JSON优先,DSL兜底) -> FormulaPlan(top_k, threshold, order, meta_filters);
- prompt 或 plan.query -> 嵌入向量;
- db.vector_search_paragraphs(query_vec, limit=top_k, threshold, book_id) -> 结果;
- 元过滤(占位) -> 按相似度排序 -> SSE逐段输出;

## 6. 性能与稳定性
- 连接:async SQLAlchemy + asyncpg(NullPool);
- 向量检索:HNSW优先,IVFFlat作为fallback;
- 嵌入:批量64,异步IO;
- SSE:ping=15秒心跳;
- 缓存:LRU用于模型配置、Redis用于跨进程共享统计与热数据;
- 错误:捕获 ActiveSQLTransactionError,索引创建避免 CONCURRENTLY;
- 监控:数据库统计接口扩展 paragraphs 计数与覆盖率.

## 7. 前端约定(简述)
- 原生 EventSource 订阅;
- UI组件关注展示,数据与副作用在 hooks/服务层处理;
- 开发前本地预览与轻量E2E手动验证.

## 8. 交付与验收
- 代码:services/paragraph_service.py, services/formula_engine.py, routers/story.py, db_service模型与索引更新;
- 文档:本文件;
- 测试:提供示例调用与SSE预览;
- PR:录屏或截图证明SSE拼接与检索效果.

## 9. 后续扩展建议
- 元数据自动提取:人物/场景/情感标签提取;
- 质量评估:连贯性、多样性评分器;
- 混合检索:全文检索+向量检索融合;
- 工作流:拼接后再生成润色(SSE多阶段).

