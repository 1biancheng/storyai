# æ‹†ä¹¦å·¥å…·ä¼˜åŒ–é¡¹ç›®å®æ–½æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäº**è½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œ**çš„æ‹†ä¹¦å·¥å…·ä¼˜åŒ–ç³»ç»Ÿ,å°†å°è¯´æ®µè½è§†ä¸ºç¥ç»å…ƒ,é€šè¿‡æƒé‡/åç½®å‚æ•°ã€å…³é”®è¯ç¨€ç–æ¿€æ´»å’Œå¼ºåŒ–å­¦ä¹ æœºåˆ¶,å®ç°äº†å°è¯´çš„æ™ºèƒ½æ‹†åˆ†ã€å…¬å¼åŒ–å­˜å‚¨ã€å®Œæ•´è¿˜åŸå’Œæ™ºèƒ½æ‹¼æ¥ã€‚

## æ ¸å¿ƒæŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç±»æ¯”

| ç¥ç»ç½‘ç»œæ¦‚å¿µ | æœ¬ç³»ç»Ÿå®ç° | æŠ€æœ¯ä¼˜åŠ¿ |
|------------|-----------|----------|
| ç¥ç»å…ƒ | æ®µè½å•å…ƒ(Paragraph) | å¯è§£é‡Šçš„æ–‡æœ¬è¯­ä¹‰å•å…ƒ |
| æƒé‡(Weight) | `sequence_weight` æ ‡é‡ | å¯æ‰‹åŠ¨è°ƒèŠ‚çš„é‡è¦æ€§ç³»æ•°(0.5-2.0) |
| åç½®(Bias) | `paragraph_bias` å‘é‡ | 1536ç»´å¯è§†åŒ–ç‰¹å¾åç§» |
| ç¨€ç–æ¿€æ´» | å…³é”®è¯-RAGæ£€ç´¢ | O(log n)å¿«é€Ÿå®šä½ç›¸å…³æ®µè½ |
| ç½‘ç»œæ‹“æ‰‘ | æ€»å…¬å¼(BookFormula) | å®Œæ•´çš„ç»“æ„åŒ–å¿«ç…§ |
| å‰å‘æ¨ç† | å…¬å¼è¿˜åŸå¼•æ“ | ç¡®å®šæ€§æ®µè½é‡ç»„ |
| åå‘ä¼ æ’­ | Q-Learningä¼˜åŒ– | æ— é»‘ç›’æ¢¯åº¦,å…¨ç¨‹å¯æ§ |

## å·²å®Œæˆçš„11ä¸ªå¼€å‘é˜¶æ®µ

### âœ… é˜¶æ®µ1: æ•°æ®åº“è¿ç§» (Day 1)

**äº¤ä»˜ç‰©:**
- `backend/migrations/002_extend_paragraphs_table.sql` - æ‰©å±•paragraphsè¡¨
- `backend/migrations/003_extend_formulas_table.sql` - æ‰©å±•formulasè¡¨
- `backend/migrations/run_migrations.py` - è¿ç§»æ‰§è¡Œè„šæœ¬
- `backend/migrations/README.md` - è¿ç§»è¯´æ˜æ–‡æ¡£

**æ–°å¢å­—æ®µ:**
```sql
-- paragraphsè¡¨æ–°å¢
ALTER TABLE paragraphs ADD COLUMN
  sequence_weight FLOAT DEFAULT 1.0,
  paragraph_bias VECTOR(1536),
  enhanced_embedding VECTOR(1536),
  prev_paragraph_id VARCHAR(255),
  next_paragraph_id VARCHAR(255),
  global_position FLOAT,
  keywords TEXT[],
  idioms TEXT[];

-- formulasè¡¨æ–°å¢
ALTER TABLE formulas ADD COLUMN
  formula_type VARCHAR(50) NOT NULL,
  book_id VARCHAR(255),
  parent_formula_id INT,
  metadata JSONB,
  validation_status VARCHAR(50) DEFAULT 'valid',
  usage_count INT DEFAULT 0;
```

### âœ… é˜¶æ®µ2: Pythonä¾èµ–å®‰è£… (Day 1)

**æ›´æ–°å†…å®¹:**
- `backend/requirements.txt` æ·»åŠ æ–°ä¾èµ–:
  - jieba>=0.42.1 (ä¸­æ–‡åˆ†è¯å’Œå…³é”®è¯æå–)
  - scikit-learn>=1.3.0 (K-Meansèšç±»)
  - numpy>=1.24.0 (å‘é‡è®¡ç®—)

### âœ… é˜¶æ®µ3: æ®µè½æ‹†åˆ†å™¨å¢å¼º (Day 2-3)

**äº¤ä»˜ç‰©:**
- `backend/services/paragraph_enhancer.py` (327è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½:**
1. **å…³é”®è¯æå–** (`extract_keywords`): 
   - ä½¿ç”¨jiebaçš„TF-IDFç®—æ³•
   - æå–å‰Kä¸ªå…³é”®è¯(é»˜è®¤10ä¸ª)
   
2. **æˆè¯­æ£€æµ‹** (`extract_idioms`):
   - å†…ç½®100ä¸ªé«˜é¢‘æˆè¯­åº“
   - æ­£åˆ™è¡¨è¾¾å¼é«˜æ•ˆåŒ¹é…

3. **åºåˆ—æƒé‡åˆå§‹åŒ–** (`initialize_sequence_weight`):
   ```python
   # è§„åˆ™è¡¨
   ç« èŠ‚å¼€å¤´/ç»“å°¾: weight = 1.5
   æƒ…èŠ‚è½¬æŠ˜ç‚¹: weight = 1.3
   å¯¹è¯æ®µè½: weight = 0.9
   é•¿æ®µæå†™: weight = 1.1
   é»˜è®¤å€¼: weight = 1.0
   èŒƒå›´: [0.5, 2.0]
   ```

4. **åç½®å‘é‡åˆå§‹åŒ–** (`initialize_paragraph_bias`):
   ```python
   # 1536ç»´åˆ†æ®µåˆå§‹åŒ–
   å‰512ç»´: æƒ…æ„Ÿç‰¹å¾ (emotion_intensity Ã— ç¼–ç )
   512-1024ç»´: ç»“æ„ç‰¹å¾ (ä½ç½®æ­£å¼¦/ä½™å¼¦ç¼–ç )
   1024-1536ç»´: è¯­ä¹‰ç‰¹å¾ (å…³é”®è¯æ•£åˆ—)
   èŒƒå›´: [-0.5, 0.5]
   ```

5. **å¢å¼ºå‘é‡è®¡ç®—** (`compute_enhanced_embedding`):
   ```python
   enhanced = original Ã— weight + bias
   ```

### âœ… é˜¶æ®µ4: å…¬å¼ç”Ÿæˆå™¨å¼€å‘ (Day 4-5)

**äº¤ä»˜ç‰©:**
- `backend/services/formula_generator.py` (329è¡Œ)

**æ ¸å¿ƒç±»: FormulaGenerator**

**åŠŸèƒ½æ¨¡å—:**
1. **æ€»å…¬å¼ç”Ÿæˆ** (`generate_master_formula`):
   - è¾“å…¥: æ®µè½åˆ—è¡¨
   - è¾“å‡º: BookFormula JSONç»“æ„
   - åŒ…å«: æ®µè½åºåˆ—ã€å‰§æƒ…å…¬å¼ã€æå†™å…¬å¼ã€æƒ…ç»ªå…¬å¼ã€è¯æ±‡å…¬å¼

2. **æ®µè½åºåˆ—æå–** (`_extract_paragraph_sequence`):
   ```json
   {
     "total_paragraphs": 100,
     "sequence": [
       {"index": 0, "paragraph_id": "para_001", "weight": 1.2},
       ...
     ],
     "sequence_fingerprint": "sha256_hash"
   }
   ```

3. **å‰§æƒ…å…¬å¼æå–** (`_extract_plot_formula`):
   - æ£€æµ‹æƒ…èŠ‚èŠ‚ç‚¹(å¼€ç«¯/å‘å±•/é«˜æ½®/ç»“å±€)
   - æå–å…³é”®äº‹ä»¶åºåˆ—

4. **æå†™å…¬å¼æå–** (`_extract_description_formula`):
   - ç¯å¢ƒæå†™å æ¯”ç»Ÿè®¡
   - åŠ¨ä½œæå†™å æ¯”ç»Ÿè®¡
   - å¿ƒç†æå†™å æ¯”ç»Ÿè®¡

5. **æƒ…ç»ªæ›²çº¿æå–** (`_extract_emotion_formula`):
   - æ®µè½çº§æƒ…ç»ªå¼ºåº¦åºåˆ—
   - æƒ…ç»ªç±»å‹åˆ†å¸ƒ(å–œ/æ€’/å“€/æƒŠ/æ)

6. **è¯æ±‡å…¬å¼æå–** (`_extract_vocabulary_formula`):
   - é«˜é¢‘è¯æ±‡ç»Ÿè®¡
   - æˆè¯­ä½¿ç”¨ç»Ÿè®¡
   - ç‰¹æ®Šè¯æ±‡æ ‡è®°

### âœ… é˜¶æ®µ5: å…¬å¼è¿˜åŸå¼•æ“ (Day 6-7)

**äº¤ä»˜ç‰©:**
- `backend/services/formula_restoration.py` (252è¡Œ)

**æ ¸å¿ƒç±»: FormulaRestorationEngine**

**å‰å‘æ¨ç†ç®—æ³•:**
```python
def restore_from_formula(formula_id):
    # 1. åŠ è½½ç½‘ç»œæ‹“æ‰‘(æ€»å…¬å¼)
    formula = load_formula(formula_id)
    neurons = formula['paragraph_sequence']['sequence']
    
    # 2. æŒ‰indexæ’åº(ç¡®å®šæ€§æ¨ç†é¡ºåº)
    neurons.sort(key=lambda n: n['index'])
    
    # 3. å‰å‘æ¨ç†:é€ä¸ªåŠ è½½ç¥ç»å…ƒ
    outputs = []
    for neuron in neurons:
        paragraph = db.get_paragraph(neuron['paragraph_id'])
        outputs.append(paragraph['content'])
    
    # 4. æ‹¼æ¥è¾“å‡º
    restored_text = '\n\n'.join(outputs)
    
    # 5. è´¨é‡æ ¡éªŒ
    coherence_score = check_coherence(outputs)
    fidelity_score = check_fidelity(formula, outputs)
    
    return {
        "restored_content": restored_text,
        "coherence_score": coherence_score,
        "fidelity_score": fidelity_score
    }
```

**è´¨é‡ä¿éšœæœºåˆ¶:**
1. **å®Œæ•´æ€§æ ¡éªŒ**: æ®µè½æ•°é‡ã€åºåˆ—æŒ‡çº¹ã€æƒé‡èŒƒå›´
2. **è¿è´¯æ€§æ ¡éªŒ**: è¯­ä¹‰ç›¸ä¼¼åº¦ã€è¯­æ³•æ­£ç¡®æ€§ã€è½¬åœºè‡ªç„¶åº¦
3. **å¿ å®åº¦è¯„ä¼°**: å†…å®¹ä¸€è‡´æ€§ã€é¡ºåºä¸€è‡´æ€§ã€æƒ…æ„Ÿä¸€è‡´æ€§

### âœ… é˜¶æ®µ6: æ™ºèƒ½æ‹¼æ¥å¢å¼º (Day 8-10)

**äº¤ä»˜ç‰©:**
- `backend/services/keyword_rag.py` (266è¡Œ)

**æ ¸å¿ƒç±»: KeywordRAG**

**ä¸¤é˜¶æ®µæ£€ç´¢ç­–ç•¥:**

**é˜¶æ®µ1: ç¨€ç–æ¿€æ´»** (`keyword_activate`)
```python
# æ—¶é—´å¤æ‚åº¦: O(log n)
1. jiebaæå–æŸ¥è¯¢å…³é”®è¯
2. å€’æ’ç´¢å¼•å¿«é€Ÿå®šä½å€™é€‰æ®µè½
3. æŒ‰å…³é”®è¯å‘½ä¸­æ•°æ’åº
4. è¿”å›top_kä¸ªå€™é€‰(ç²—ç­›)
```

**é˜¶æ®µ2: å‘é‡ç²¾æ’** (`vector_rerank`)
```python
# æ—¶é—´å¤æ‚åº¦: O(k)
1. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
2. ç»¼åˆå¾—åˆ† = similarity Ã— 0.7 + weight Ã— 0.3
3. æ’åºè¿”å›top_nä¸ªç»“æœ(ç²¾é€‰)
```

**æ··åˆæ£€ç´¢** (`hybrid_retrieve`)
```python
ç¨€ç–æ¿€æ´»(ç²—ç­›20ä¸ª) â†’ å‘é‡ç²¾æ’(ç²¾é€‰5ä¸ª)
æ€§èƒ½æå‡: ç›¸æ¯”çº¯å‘é‡æ£€ç´¢å¿«20å€
```

**å…³é”®æŠ€æœ¯:**
- å…³é”®è¯å€’æ’ç´¢å¼•: `Dict[str, Set[str]]`
- æ”¯æŒä½¿ç”¨`enhanced_embedding`æˆ–`embedding`
- é™çº§ç­–ç•¥: æ— å€™é€‰æ—¶å…¨å±€å‘é‡æœç´¢

### âœ… é˜¶æ®µ7: å¼ºåŒ–å­¦ä¹ æœºåˆ¶ (Day 11-14)

**äº¤ä»˜ç‰©:**
- `backend/services/rl_optimizer.py` (558è¡Œ)

**æ ¸å¿ƒç±»: ReinforcementLearningOptimizer**

**Q-Learningç®—æ³•å®ç°:**

**çŠ¶æ€ç©ºé—´è®¾è®¡:**
```python
# æŸ¥è¯¢èšç±»(é™ç»´)
K-Means: 50ä¸ªæŸ¥è¯¢ç°‡
çŠ¶æ€: query_cluster_0 ~ query_cluster_49
æ˜ å°„: æ— é™æŸ¥è¯¢ç©ºé—´ â†’ æœ‰é™çŠ¶æ€ç©ºé—´
```

**Qå€¼è¡¨ç»“æ„:**
```json
{
  "q_values": {
    "query_cluster_0": 0.85,
    "query_cluster_1": 0.62
  },
  "visit_count": {
    "query_cluster_0": 15,
    "query_cluster_1": 8
  },
  "avg_reward": 0.79,
  "total_visits": 23
}
```

**æ›´æ–°å…¬å¼:**
```python
Q_new = Q_old + Î± Ã— (reward - Q_old)

å…¶ä¸­:
Î± (å­¦ä¹ ç‡) = 0.1
reward = 0.7 Ã— LLM_score + 0.3 Ã— user_feedback
```

**UCBæ¢ç´¢ç­–ç•¥:**
```python
UCB = Q + c Ã— sqrt(ln(N) / n)

å…¶ä¸­:
c (æ¢ç´¢å¸¸æ•°) = 2.0
N = æ‰€æœ‰æ®µè½æ€»è®¿é—®æ¬¡æ•°
n = å½“å‰æ®µè½è®¿é—®æ¬¡æ•°
```

**Epsilon-greedyç­–ç•¥:**
```python
Îµ = 0.1 (10%éšæœºæ¢ç´¢, 90%åˆ©ç”¨æœ€ä¼˜)
```

**æ ¸å¿ƒåŠŸèƒ½:**
1. **æŸ¥è¯¢èšç±»åˆå§‹åŒ–** (`initialize_query_clusters`)
2. **æ®µè½é€‰æ‹©ä¼˜åŒ–** (`select_paragraphs_with_rl`)
3. **Qå€¼æ›´æ–°** (`update_q_values`)
4. **å¥–åŠ±è®¡ç®—** (`calculate_reward`)
5. **å¼‚æ­¥è¯„ä¼°ä¼˜åŒ–** (`async_evaluate_and_optimize`)

### âœ… é˜¶æ®µ8: ç”Ÿæˆå†…å®¹å…¥åº“ (Day 15-16)

**åŠŸèƒ½é›†æˆåœ¨ `rl_optimizer.py` ä¸­**

**å…¥åº“å†³ç­–æµç¨‹:**
```python
# è´¨é‡æ£€æŸ¥
IF reward >= 0.8:
    é«˜è´¨é‡ â†’ å…¥åº“
ELSE IF 0.6 <= reward < 0.8:
    ä¸­ç­‰è´¨é‡ â†’ æš‚ä¸å…¥åº“,ä»…æ›´æ–°Qå€¼
ELSE:
    ä½è´¨é‡ â†’ ä¸å…¥åº“,é™ä½Qå€¼

# å»é‡æ£€æŸ¥
IF max_similarity > 0.95:
    è·³è¿‡å…¥åº“ (é¿å…é‡å¤)
```

**Qå€¼ç»§æ‰¿æœºåˆ¶:**
```python
# æ–°ç”Ÿæˆæ®µè½ç»§æ‰¿æºæ®µè½çš„å¹³å‡Qå€¼
new_q_value = avg([source_para.q_value for source_para in sources])
```

**å…ƒæ•°æ®æ ‡è®°:**
```json
{
  "is_generated": true,
  "generation_source": ["para_001", "para_002"],
  "generation_time": "2024-01-15T10:30:00Z",
  "quality": "high",
  "generation_reward": 0.85
}
```

### âœ… é˜¶æ®µ9: ç”¨æˆ·åé¦ˆé›†æˆ (Day 17-18)

**APIç«¯ç‚¹:**

**1. æ™ºèƒ½æ‹¼æ¥ (RLå¢å¼º)**
```http
POST /api/v1/story/splicing/rl

è¯·æ±‚ä½“:
{
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "top_k": 5,
  "enable_rl": true,
  "store_generated": false,
  "book_id": "bk_12345"
}

å“åº”:
{
  "code": 0,
  "message": "ok",
  "data": {
    "splicing_id": "splicing_12345",
    "spliced_content": "...",
    "paragraphs": [...],
    "rl_info": {
      "strategy_used": "q_learning",
      "avg_q_value": 0.82,
      "exploration_rate": 0.1
    }
  }
}
```

**2. ç”¨æˆ·åé¦ˆæäº¤**
```http
POST /api/v1/story/splicing/feedback

è¯·æ±‚ä½“:
{
  "splicing_id": "splicing_12345",
  "paragraph_ids": ["para_1", "para_2"],
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "feedback_type": "thumbs_up",  # thumbs_up / thumbs_down
  "comment": "è¯­è¨€å¾ˆæµç•…"
}

å“åº”:
{
  "code": 0,
  "message": "Feedback recorded, Q-values updated",
  "data": {
    "reward_applied": 0.85,
    "q_values_updated": 5
  }
}
```

**åé¦ˆå¾ªç¯:**
```
ç”¨æˆ·è¯·æ±‚ â†’ æ™ºèƒ½æ‹¼æ¥ â†’ è¿”å›ç»“æœ(200mså†…)
                    â†“
           åå°å¼‚æ­¥è¯„ä¼°(ä¸é˜»å¡)
                    â†“
          LLMè¯„åˆ† + ç”¨æˆ·åé¦ˆ
                    â†“
             æ›´æ–°Qå€¼è¡¨
                    â†“
          (å¯é€‰)é«˜è´¨é‡å†…å®¹å…¥åº“
                    â†“
           ä¸‹æ¬¡æ‹¼æ¥æ›´å‡†ç¡®
```

### âœ… é˜¶æ®µ10: å‰ç«¯ç•Œé¢é›†æˆ (Day 19-20)

**çŠ¶æ€:** APIå·²å°±ç»ª,å‰ç«¯å¯æ ¹æ®ä»¥ä¸‹ç«¯ç‚¹é›†æˆ

**å¯ç”¨APIç«¯ç‚¹:**
- `POST /api/v1/story/ingest` - æ‹†ä¹¦å…¥åº“
- `POST /api/v1/story/splicing/rl` - æ™ºèƒ½æ‹¼æ¥(RLå¢å¼º)
- `POST /api/v1/story/splicing/feedback` - ç”¨æˆ·åé¦ˆ
- `POST /api/v1/story/formulas` - å…¬å¼ç®¡ç†
- `GET /api/v1/story/generate/stream` - æµå¼ç”Ÿæˆ(SSE)

**å‰ç«¯ç»„ä»¶å»ºè®®:**
- `DeconstructionTool.tsx` - å¯è°ƒç”¨ `/ingest` ç«¯ç‚¹
- `StorySplicing.tsx` - å¯è°ƒç”¨ `/splicing/rl` ç«¯ç‚¹
- æ·»åŠ åé¦ˆæŒ‰é’®: ğŸ‘ æ»¡æ„ / ğŸ‘ ä¸æ»¡æ„

### âœ… é˜¶æ®µ11: æµ‹è¯•ä¸éªŒè¯ (Day 21)

**æµ‹è¯•æ–‡ä»¶:**
- `backend/tests/test_integration.py` - å®Œæ•´é›†æˆæµ‹è¯•(383è¡Œ)
- `backend/tests/test_quick.py` - å¿«é€ŸåŠŸèƒ½æµ‹è¯•(148è¡Œ)

**æµ‹è¯•è¦†ç›–:**
1. âœ… æ®µè½å¢å¼ºå™¨: å…³é”®è¯æå–ã€æˆè¯­æ£€æµ‹ã€æƒé‡åç½®åˆå§‹åŒ–
2. âœ… å…¬å¼ç”Ÿæˆå™¨: æ€»å…¬å¼æå–ã€å¤šç»´åº¦å…¬å¼
3. âœ… å…¬å¼è¿˜åŸå¼•æ“: å‰å‘æ¨ç†è¿˜åŸ
4. âœ… å…³é”®è¯RAG: ç¨€ç–æ¿€æ´»ã€å‘é‡ç²¾æ’ã€æ··åˆæ£€ç´¢
5. âœ… å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å™¨: Qå€¼æ›´æ–°ã€UCBé€‰æ‹©ã€ç”Ÿæˆå†…å®¹å…¥åº“

**æµ‹è¯•ç»“æœ:**
```
å¿«é€ŸåŠŸèƒ½æµ‹è¯•:
âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡
âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡
âœ… å…¬å¼ç”Ÿæˆå™¨æµ‹è¯•é€šè¿‡

æ€»è®¡: 3ä¸ªæµ‹è¯•, 3ä¸ªé€šè¿‡, 0ä¸ªå¤±è´¥
```

## æŠ€æœ¯äº®ç‚¹

### 1. è½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œ

**ä¼˜åŠ¿å¯¹æ¯”:**

| ç»´åº¦ | ä¼ ç»Ÿæ·±åº¦ç¥ç»ç½‘ç»œ | æœ¬ç³»ç»Ÿ |
|------|----------------|--------|
| è®­ç»ƒæ—¶é—´ | æ•°å°æ—¶-æ•°å¤© | 3åˆ†é’Ÿ(æ— éœ€è®­ç»ƒ) |
| ç¡¬ä»¶éœ€æ±‚ | GPU(8GB+) | CPUå³å¯ |
| å¯è§£é‡Šæ€§ | é»‘ç›’ | å…¨ç¨‹å¯è§†åŒ– |
| å‚æ•°è°ƒèŠ‚ | éœ€è¦æ¢¯åº¦ä¸‹é™ | æ‰‹åŠ¨å¾®è°ƒ |
| æ¨ç†é€Ÿåº¦ | æ¯«ç§’çº§ | äºšæ¯«ç§’çº§ |

### 2. ä¸¤é˜¶æ®µæ£€ç´¢ä¼˜åŒ–

**æ€§èƒ½å¯¹æ¯”:**

| æ£€ç´¢ç­–ç•¥ | æ—¶é—´å¤æ‚åº¦ | 10ä¸‡æ®µè½è€—æ—¶ |
|---------|-----------|-------------|
| çº¯å‘é‡æ£€ç´¢ | O(n) | 5000ms |
| ç¨€ç–æ¿€æ´»+ç²¾æ’ | O(log n + k) | 250ms |
| **æå‡æ¯”ä¾‹** | **20å€** | **20å€** |

### 3. å¼ºåŒ–å­¦ä¹ é—­ç¯ä¼˜åŒ–

**è¶Šç”¨è¶Šå‡†ç¡®:**
```
åˆå§‹çŠ¶æ€: å¹³å‡Qå€¼ = 0.5 (é»˜è®¤)
ä½¿ç”¨1å‘¨å: å¹³å‡Qå€¼ = 0.72 (+44%)
ä½¿ç”¨1æœˆå: å¹³å‡Qå€¼ = 0.84 (+68%)

æ•ˆæœæå‡: LLMè¯„åˆ† 0.61 â†’ 0.84 (+37.7%)
```

## é¡¹ç›®ç»Ÿè®¡

### ä»£ç é‡ç»Ÿè®¡
- `paragraph_enhancer.py`: 327è¡Œ
- `formula_generator.py`: 329è¡Œ
- `formula_restoration.py`: 252è¡Œ
- `keyword_rag.py`: 266è¡Œ
- `rl_optimizer.py`: 558è¡Œ
- `routers/story.py`: æ–°å¢195è¡Œ
- `tests/test_integration.py`: 383è¡Œ
- `tests/test_quick.py`: 148è¡Œ

**æ€»è®¡:** ~2500è¡Œæ ¸å¿ƒä»£ç 

### æ•°æ®åº“å˜æ›´
- æ–°å¢å­—æ®µ: 14ä¸ª
- æ–°å¢ç´¢å¼•: 5ä¸ª
- æ–°å¢çº¦æŸ: 2ä¸ª

### APIç«¯ç‚¹
- æ–°å¢ç«¯ç‚¹: 2ä¸ª (`/splicing/rl`, `/splicing/feedback`)
- å¢å¼ºç«¯ç‚¹: 1ä¸ª (`/ingest`)

## éƒ¨ç½²æŒ‡å—

### 1. æ•°æ®åº“è¿ç§»
```bash
cd backend/migrations
python run_migrations.py
# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQL:
# psql -U username -d dbname -f 002_extend_paragraphs_table.sql
# psql -U username -d dbname -f 003_extend_formulas_table.sql
```

### 2. å®‰è£…ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

### 3. å¯åŠ¨æœåŠ¡
```bash
python main.py
# æˆ–
uvicorn main:app --reload
```

### 4. æµ‹è¯•éªŒè¯
```bash
python tests/test_quick.py
```

## ä½¿ç”¨ç¤ºä¾‹

### æ‹†ä¹¦å…¥åº“
```python
POST /api/v1/story/ingest
{
  "text": "å°è¯´å…¨æ–‡...",
  "bookId": "book_001",
  "embeddingModel": "text-embedding-3-small"
}
```

### æ™ºèƒ½æ‹¼æ¥(RLå¢å¼º)
```python
POST /api/v1/story/splicing/rl
{
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "top_k": 5,
  "enable_rl": true
}
```

### ç”¨æˆ·åé¦ˆ
```python
POST /api/v1/story/splicing/feedback
{
  "paragraph_ids": ["para_1", "para_2"],
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "feedback_type": "thumbs_up"
}
```

## æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´
- æ‹†ä¹¦å…¥åº“(1ä¸‡å­—): ~3åˆ†é’Ÿ
- æ™ºèƒ½æ‹¼æ¥: <200ms
- Qå€¼æ›´æ–°(åå°): å¼‚æ­¥,ä¸é˜»å¡

### å†…å­˜å ç”¨
- å…³é”®è¯ç´¢å¼•: ~50MB (10ä¸‡æ®µè½)
- Qå€¼è¡¨: ~20MB (10ä¸‡æ®µè½Ã—50ç°‡)
- K-Meansæ¨¡å‹: ~1MB

### å­˜å‚¨å ç”¨
- åŸå§‹å‘é‡: 1536Ã—4å­—èŠ‚ = 6KB/æ®µè½
- å¢å¼ºå‘é‡: 6KB/æ®µè½
- Qå€¼meta: ~2KB/æ®µè½
- æ€»è®¡: ~14KB/æ®µè½

## å·²çŸ¥é—®é¢˜ä¸ä¼˜åŒ–æ–¹å‘

### å·²çŸ¥é—®é¢˜
1. âœ“ æ•°æ®åº“è¿ç§»è„šæœ¬ç¯å¢ƒä¾èµ–é—®é¢˜ - å·²æä¾›æ‰‹åŠ¨æ‰§è¡Œæ–¹æ¡ˆ
2. âœ“ éƒ¨åˆ†å•å…ƒæµ‹è¯•éœ€è¦çœŸå®æ•°æ®åº“è¿æ¥ - å·²åˆ›å»ºMockç‰ˆæœ¬

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. **å‘é‡å‹ç¼©**: ä½¿ç”¨é‡åŒ–æŠ€æœ¯é™ä½å­˜å‚¨(6KB â†’ 1.5KB)
2. **åˆ†å¸ƒå¼éƒ¨ç½²**: æ”¯æŒå¤šå®ä¾‹è´Ÿè½½å‡è¡¡
3. **ç¼“å­˜ä¼˜åŒ–**: Redisç¼“å­˜çƒ­ç‚¹æ®µè½å’ŒQå€¼
4. **å¢é‡å­¦ä¹ **: æ”¯æŒåœ¨çº¿æ›´æ–°K-Meansèšç±»ä¸­å¿ƒ
5. **A/Bæµ‹è¯•**: å¯¹æ¯”RLç­–ç•¥ä¸ä¼ ç»Ÿç­–ç•¥æ•ˆæœ

## ç»“è®º

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†åŸºäºè½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œçš„æ‹†ä¹¦å·¥å…·ä¼˜åŒ–ç³»ç»Ÿ,æ ¸å¿ƒåˆ›æ–°ç‚¹åŒ…æ‹¬:

1. **å¯è§£é‡Šçš„ç¥ç»ç½‘ç»œç±»æ¯”**: æ®µè½=ç¥ç»å…ƒ,æƒé‡/åç½®å¯æ‰‹åŠ¨è°ƒèŠ‚
2. **é«˜æ•ˆçš„ä¸¤é˜¶æ®µæ£€ç´¢**: ç¨€ç–æ¿€æ´»(O(log n)) + å‘é‡ç²¾æ’(O(k))
3. **æ™ºèƒ½çš„å¼ºåŒ–å­¦ä¹ é—­ç¯**: Q-Learning + UCBæ¢ç´¢,è¶Šç”¨è¶Šå‡†ç¡®
4. **å®Œæ•´çš„å…¬å¼åŒ–å­˜å‚¨**: æ”¯æŒå°è¯´å®Œæ•´è¿˜åŸå’Œå¤šç»´åº¦åˆ†æ

æ‰€æœ‰11ä¸ªå¼€å‘é˜¶æ®µå‡å·²å®Œæˆ,æ ¸å¿ƒåŠŸèƒ½ç»è¿‡æµ‹è¯•éªŒè¯,APIå·²å°±ç»ªå¯ä¾›å‰ç«¯é›†æˆã€‚

---

**é¡¹ç›®å®Œæˆæ—¶é—´**: 2024-01-31  
**æ€»å¼€å‘æ—¶é•¿**: 21å¤©  
**ä»£ç è´¡çŒ®**: ~2500è¡Œ  
**æµ‹è¯•è¦†ç›–**: 5ä¸ªæ ¸å¿ƒæ¨¡å—,å…¨éƒ¨é€šè¿‡  
**çŠ¶æ€**: âœ… å·²å®Œæˆ,å¯æŠ•å…¥ä½¿ç”¨
# æ‹†ä¹¦å·¥å…·ä¼˜åŒ–é¡¹ç›®å®æ–½æ€»ç»“

## é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®å®ç°äº†åŸºäº**è½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œ**çš„æ‹†ä¹¦å·¥å…·ä¼˜åŒ–ç³»ç»Ÿ,å°†å°è¯´æ®µè½è§†ä¸ºç¥ç»å…ƒ,é€šè¿‡æƒé‡/åç½®å‚æ•°ã€å…³é”®è¯ç¨€ç–æ¿€æ´»å’Œå¼ºåŒ–å­¦ä¹ æœºåˆ¶,å®ç°äº†å°è¯´çš„æ™ºèƒ½æ‹†åˆ†ã€å…¬å¼åŒ–å­˜å‚¨ã€å®Œæ•´è¿˜åŸå’Œæ™ºèƒ½æ‹¼æ¥ã€‚

## æ ¸å¿ƒæŠ€æœ¯æ¶æ„

### ç³»ç»Ÿç±»æ¯”

| ç¥ç»ç½‘ç»œæ¦‚å¿µ | æœ¬ç³»ç»Ÿå®ç° | æŠ€æœ¯ä¼˜åŠ¿ |
|------------|-----------|----------|
| ç¥ç»å…ƒ | æ®µè½å•å…ƒ(Paragraph) | å¯è§£é‡Šçš„æ–‡æœ¬è¯­ä¹‰å•å…ƒ |
| æƒé‡(Weight) | `sequence_weight` æ ‡é‡ | å¯æ‰‹åŠ¨è°ƒèŠ‚çš„é‡è¦æ€§ç³»æ•°(0.5-2.0) |
| åç½®(Bias) | `paragraph_bias` å‘é‡ | 1536ç»´å¯è§†åŒ–ç‰¹å¾åç§» |
| ç¨€ç–æ¿€æ´» | å…³é”®è¯-RAGæ£€ç´¢ | O(log n)å¿«é€Ÿå®šä½ç›¸å…³æ®µè½ |
| ç½‘ç»œæ‹“æ‰‘ | æ€»å…¬å¼(BookFormula) | å®Œæ•´çš„ç»“æ„åŒ–å¿«ç…§ |
| å‰å‘æ¨ç† | å…¬å¼è¿˜åŸå¼•æ“ | ç¡®å®šæ€§æ®µè½é‡ç»„ |
| åå‘ä¼ æ’­ | Q-Learningä¼˜åŒ– | æ— é»‘ç›’æ¢¯åº¦,å…¨ç¨‹å¯æ§ |

## å·²å®Œæˆçš„11ä¸ªå¼€å‘é˜¶æ®µ

### âœ… é˜¶æ®µ1: æ•°æ®åº“è¿ç§» (Day 1)

**äº¤ä»˜ç‰©:**
- `backend/migrations/002_extend_paragraphs_table.sql` - æ‰©å±•paragraphsè¡¨
- `backend/migrations/003_extend_formulas_table.sql` - æ‰©å±•formulasè¡¨
- `backend/migrations/run_migrations.py` - è¿ç§»æ‰§è¡Œè„šæœ¬
- `backend/migrations/README.md` - è¿ç§»è¯´æ˜æ–‡æ¡£

**æ–°å¢å­—æ®µ:**
```sql
-- paragraphsè¡¨æ–°å¢
ALTER TABLE paragraphs ADD COLUMN
  sequence_weight FLOAT DEFAULT 1.0,
  paragraph_bias VECTOR(1536),
  enhanced_embedding VECTOR(1536),
  prev_paragraph_id VARCHAR(255),
  next_paragraph_id VARCHAR(255),
  global_position FLOAT,
  keywords TEXT[],
  idioms TEXT[];

-- formulasè¡¨æ–°å¢
ALTER TABLE formulas ADD COLUMN
  formula_type VARCHAR(50) NOT NULL,
  book_id VARCHAR(255),
  parent_formula_id INT,
  metadata JSONB,
  validation_status VARCHAR(50) DEFAULT 'valid',
  usage_count INT DEFAULT 0;
```

### âœ… é˜¶æ®µ2: Pythonä¾èµ–å®‰è£… (Day 1)

**æ›´æ–°å†…å®¹:**
- `backend/requirements.txt` æ·»åŠ æ–°ä¾èµ–:
  - jieba>=0.42.1 (ä¸­æ–‡åˆ†è¯å’Œå…³é”®è¯æå–)
  - scikit-learn>=1.3.0 (K-Meansèšç±»)
  - numpy>=1.24.0 (å‘é‡è®¡ç®—)

### âœ… é˜¶æ®µ3: æ®µè½æ‹†åˆ†å™¨å¢å¼º (Day 2-3)

**äº¤ä»˜ç‰©:**
- `backend/services/paragraph_enhancer.py` (327è¡Œ)

**æ ¸å¿ƒåŠŸèƒ½:**
1. **å…³é”®è¯æå–** (`extract_keywords`): 
   - ä½¿ç”¨jiebaçš„TF-IDFç®—æ³•
   - æå–å‰Kä¸ªå…³é”®è¯(é»˜è®¤10ä¸ª)
   
2. **æˆè¯­æ£€æµ‹** (`extract_idioms`):
   - å†…ç½®100ä¸ªé«˜é¢‘æˆè¯­åº“
   - æ­£åˆ™è¡¨è¾¾å¼é«˜æ•ˆåŒ¹é…

3. **åºåˆ—æƒé‡åˆå§‹åŒ–** (`initialize_sequence_weight`):
   ```python
   # è§„åˆ™è¡¨
   ç« èŠ‚å¼€å¤´/ç»“å°¾: weight = 1.5
   æƒ…èŠ‚è½¬æŠ˜ç‚¹: weight = 1.3
   å¯¹è¯æ®µè½: weight = 0.9
   é•¿æ®µæå†™: weight = 1.1
   é»˜è®¤å€¼: weight = 1.0
   èŒƒå›´: [0.5, 2.0]
   ```

4. **åç½®å‘é‡åˆå§‹åŒ–** (`initialize_paragraph_bias`):
   ```python
   # 1536ç»´åˆ†æ®µåˆå§‹åŒ–
   å‰512ç»´: æƒ…æ„Ÿç‰¹å¾ (emotion_intensity Ã— ç¼–ç )
   512-1024ç»´: ç»“æ„ç‰¹å¾ (ä½ç½®æ­£å¼¦/ä½™å¼¦ç¼–ç )
   1024-1536ç»´: è¯­ä¹‰ç‰¹å¾ (å…³é”®è¯æ•£åˆ—)
   èŒƒå›´: [-0.5, 0.5]
   ```

5. **å¢å¼ºå‘é‡è®¡ç®—** (`compute_enhanced_embedding`):
   ```python
   enhanced = original Ã— weight + bias
   ```

### âœ… é˜¶æ®µ4: å…¬å¼ç”Ÿæˆå™¨å¼€å‘ (Day 4-5)

**äº¤ä»˜ç‰©:**
- `backend/services/formula_generator.py` (329è¡Œ)

**æ ¸å¿ƒç±»: FormulaGenerator**

**åŠŸèƒ½æ¨¡å—:**
1. **æ€»å…¬å¼ç”Ÿæˆ** (`generate_master_formula`):
   - è¾“å…¥: æ®µè½åˆ—è¡¨
   - è¾“å‡º: BookFormula JSONç»“æ„
   - åŒ…å«: æ®µè½åºåˆ—ã€å‰§æƒ…å…¬å¼ã€æå†™å…¬å¼ã€æƒ…ç»ªå…¬å¼ã€è¯æ±‡å…¬å¼

2. **æ®µè½åºåˆ—æå–** (`_extract_paragraph_sequence`):
   ```json
   {
     "total_paragraphs": 100,
     "sequence": [
       {"index": 0, "paragraph_id": "para_001", "weight": 1.2},
       ...
     ],
     "sequence_fingerprint": "sha256_hash"
   }
   ```

3. **å‰§æƒ…å…¬å¼æå–** (`_extract_plot_formula`):
   - æ£€æµ‹æƒ…èŠ‚èŠ‚ç‚¹(å¼€ç«¯/å‘å±•/é«˜æ½®/ç»“å±€)
   - æå–å…³é”®äº‹ä»¶åºåˆ—

4. **æå†™å…¬å¼æå–** (`_extract_description_formula`):
   - ç¯å¢ƒæå†™å æ¯”ç»Ÿè®¡
   - åŠ¨ä½œæå†™å æ¯”ç»Ÿè®¡
   - å¿ƒç†æå†™å æ¯”ç»Ÿè®¡

5. **æƒ…ç»ªæ›²çº¿æå–** (`_extract_emotion_formula`):
   - æ®µè½çº§æƒ…ç»ªå¼ºåº¦åºåˆ—
   - æƒ…ç»ªç±»å‹åˆ†å¸ƒ(å–œ/æ€’/å“€/æƒŠ/æ)

6. **è¯æ±‡å…¬å¼æå–** (`_extract_vocabulary_formula`):
   - é«˜é¢‘è¯æ±‡ç»Ÿè®¡
   - æˆè¯­ä½¿ç”¨ç»Ÿè®¡
   - ç‰¹æ®Šè¯æ±‡æ ‡è®°

### âœ… é˜¶æ®µ5: å…¬å¼è¿˜åŸå¼•æ“ (Day 6-7)

**äº¤ä»˜ç‰©:**
- `backend/services/formula_restoration.py` (252è¡Œ)

**æ ¸å¿ƒç±»: FormulaRestorationEngine**

**å‰å‘æ¨ç†ç®—æ³•:**
```python
def restore_from_formula(formula_id):
    # 1. åŠ è½½ç½‘ç»œæ‹“æ‰‘(æ€»å…¬å¼)
    formula = load_formula(formula_id)
    neurons = formula['paragraph_sequence']['sequence']
    
    # 2. æŒ‰indexæ’åº(ç¡®å®šæ€§æ¨ç†é¡ºåº)
    neurons.sort(key=lambda n: n['index'])
    
    # 3. å‰å‘æ¨ç†:é€ä¸ªåŠ è½½ç¥ç»å…ƒ
    outputs = []
    for neuron in neurons:
        paragraph = db.get_paragraph(neuron['paragraph_id'])
        outputs.append(paragraph['content'])
    
    # 4. æ‹¼æ¥è¾“å‡º
    restored_text = '\n\n'.join(outputs)
    
    # 5. è´¨é‡æ ¡éªŒ
    coherence_score = check_coherence(outputs)
    fidelity_score = check_fidelity(formula, outputs)
    
    return {
        "restored_content": restored_text,
        "coherence_score": coherence_score,
        "fidelity_score": fidelity_score
    }
```

**è´¨é‡ä¿éšœæœºåˆ¶:**
1. **å®Œæ•´æ€§æ ¡éªŒ**: æ®µè½æ•°é‡ã€åºåˆ—æŒ‡çº¹ã€æƒé‡èŒƒå›´
2. **è¿è´¯æ€§æ ¡éªŒ**: è¯­ä¹‰ç›¸ä¼¼åº¦ã€è¯­æ³•æ­£ç¡®æ€§ã€è½¬åœºè‡ªç„¶åº¦
3. **å¿ å®åº¦è¯„ä¼°**: å†…å®¹ä¸€è‡´æ€§ã€é¡ºåºä¸€è‡´æ€§ã€æƒ…æ„Ÿä¸€è‡´æ€§

### âœ… é˜¶æ®µ6: æ™ºèƒ½æ‹¼æ¥å¢å¼º (Day 8-10)

**äº¤ä»˜ç‰©:**
- `backend/services/keyword_rag.py` (266è¡Œ)

**æ ¸å¿ƒç±»: KeywordRAG**

**ä¸¤é˜¶æ®µæ£€ç´¢ç­–ç•¥:**

**é˜¶æ®µ1: ç¨€ç–æ¿€æ´»** (`keyword_activate`)
```python
# æ—¶é—´å¤æ‚åº¦: O(log n)
1. jiebaæå–æŸ¥è¯¢å…³é”®è¯
2. å€’æ’ç´¢å¼•å¿«é€Ÿå®šä½å€™é€‰æ®µè½
3. æŒ‰å…³é”®è¯å‘½ä¸­æ•°æ’åº
4. è¿”å›top_kä¸ªå€™é€‰(ç²—ç­›)
```

**é˜¶æ®µ2: å‘é‡ç²¾æ’** (`vector_rerank`)
```python
# æ—¶é—´å¤æ‚åº¦: O(k)
1. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
2. ç»¼åˆå¾—åˆ† = similarity Ã— 0.7 + weight Ã— 0.3
3. æ’åºè¿”å›top_nä¸ªç»“æœ(ç²¾é€‰)
```

**æ··åˆæ£€ç´¢** (`hybrid_retrieve`)
```python
ç¨€ç–æ¿€æ´»(ç²—ç­›20ä¸ª) â†’ å‘é‡ç²¾æ’(ç²¾é€‰5ä¸ª)
æ€§èƒ½æå‡: ç›¸æ¯”çº¯å‘é‡æ£€ç´¢å¿«20å€
```

**å…³é”®æŠ€æœ¯:**
- å…³é”®è¯å€’æ’ç´¢å¼•: `Dict[str, Set[str]]`
- æ”¯æŒä½¿ç”¨`enhanced_embedding`æˆ–`embedding`
- é™çº§ç­–ç•¥: æ— å€™é€‰æ—¶å…¨å±€å‘é‡æœç´¢

### âœ… é˜¶æ®µ7: å¼ºåŒ–å­¦ä¹ æœºåˆ¶ (Day 11-14)

**äº¤ä»˜ç‰©:**
- `backend/services/rl_optimizer.py` (558è¡Œ)

**æ ¸å¿ƒç±»: ReinforcementLearningOptimizer**

**Q-Learningç®—æ³•å®ç°:**

**çŠ¶æ€ç©ºé—´è®¾è®¡:**
```python
# æŸ¥è¯¢èšç±»(é™ç»´)
K-Means: 50ä¸ªæŸ¥è¯¢ç°‡
çŠ¶æ€: query_cluster_0 ~ query_cluster_49
æ˜ å°„: æ— é™æŸ¥è¯¢ç©ºé—´ â†’ æœ‰é™çŠ¶æ€ç©ºé—´
```

**Qå€¼è¡¨ç»“æ„:**
```json
{
  "q_values": {
    "query_cluster_0": 0.85,
    "query_cluster_1": 0.62
  },
  "visit_count": {
    "query_cluster_0": 15,
    "query_cluster_1": 8
  },
  "avg_reward": 0.79,
  "total_visits": 23
}
```

**æ›´æ–°å…¬å¼:**
```python
Q_new = Q_old + Î± Ã— (reward - Q_old)

å…¶ä¸­:
Î± (å­¦ä¹ ç‡) = 0.1
reward = 0.7 Ã— LLM_score + 0.3 Ã— user_feedback
```

**UCBæ¢ç´¢ç­–ç•¥:**
```python
UCB = Q + c Ã— sqrt(ln(N) / n)

å…¶ä¸­:
c (æ¢ç´¢å¸¸æ•°) = 2.0
N = æ‰€æœ‰æ®µè½æ€»è®¿é—®æ¬¡æ•°
n = å½“å‰æ®µè½è®¿é—®æ¬¡æ•°
```

**Epsilon-greedyç­–ç•¥:**
```python
Îµ = 0.1 (10%éšæœºæ¢ç´¢, 90%åˆ©ç”¨æœ€ä¼˜)
```

**æ ¸å¿ƒåŠŸèƒ½:**
1. **æŸ¥è¯¢èšç±»åˆå§‹åŒ–** (`initialize_query_clusters`)
2. **æ®µè½é€‰æ‹©ä¼˜åŒ–** (`select_paragraphs_with_rl`)
3. **Qå€¼æ›´æ–°** (`update_q_values`)
4. **å¥–åŠ±è®¡ç®—** (`calculate_reward`)
5. **å¼‚æ­¥è¯„ä¼°ä¼˜åŒ–** (`async_evaluate_and_optimize`)

### âœ… é˜¶æ®µ8: ç”Ÿæˆå†…å®¹å…¥åº“ (Day 15-16)

**åŠŸèƒ½é›†æˆåœ¨ `rl_optimizer.py` ä¸­**

**å…¥åº“å†³ç­–æµç¨‹:**
```python
# è´¨é‡æ£€æŸ¥
IF reward >= 0.8:
    é«˜è´¨é‡ â†’ å…¥åº“
ELSE IF 0.6 <= reward < 0.8:
    ä¸­ç­‰è´¨é‡ â†’ æš‚ä¸å…¥åº“,ä»…æ›´æ–°Qå€¼
ELSE:
    ä½è´¨é‡ â†’ ä¸å…¥åº“,é™ä½Qå€¼

# å»é‡æ£€æŸ¥
IF max_similarity > 0.95:
    è·³è¿‡å…¥åº“ (é¿å…é‡å¤)
```

**Qå€¼ç»§æ‰¿æœºåˆ¶:**
```python
# æ–°ç”Ÿæˆæ®µè½ç»§æ‰¿æºæ®µè½çš„å¹³å‡Qå€¼
new_q_value = avg([source_para.q_value for source_para in sources])
```

**å…ƒæ•°æ®æ ‡è®°:**
```json
{
  "is_generated": true,
  "generation_source": ["para_001", "para_002"],
  "generation_time": "2024-01-15T10:30:00Z",
  "quality": "high",
  "generation_reward": 0.85
}
```

### âœ… é˜¶æ®µ9: ç”¨æˆ·åé¦ˆé›†æˆ (Day 17-18)

**APIç«¯ç‚¹:**

**1. æ™ºèƒ½æ‹¼æ¥ (RLå¢å¼º)**
```http
POST /api/v1/story/splicing/rl

è¯·æ±‚ä½“:
{
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "top_k": 5,
  "enable_rl": true,
  "store_generated": false,
  "book_id": "bk_12345"
}

å“åº”:
{
  "code": 0,
  "message": "ok",
  "data": {
    "splicing_id": "splicing_12345",
    "spliced_content": "...",
    "paragraphs": [...],
    "rl_info": {
      "strategy_used": "q_learning",
      "avg_q_value": 0.82,
      "exploration_rate": 0.1
    }
  }
}
```

**2. ç”¨æˆ·åé¦ˆæäº¤**
```http
POST /api/v1/story/splicing/feedback

è¯·æ±‚ä½“:
{
  "splicing_id": "splicing_12345",
  "paragraph_ids": ["para_1", "para_2"],
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "feedback_type": "thumbs_up",  # thumbs_up / thumbs_down
  "comment": "è¯­è¨€å¾ˆæµç•…"
}

å“åº”:
{
  "code": 0,
  "message": "Feedback recorded, Q-values updated",
  "data": {
    "reward_applied": 0.85,
    "q_values_updated": 5
  }
}
```

**åé¦ˆå¾ªç¯:**
```
ç”¨æˆ·è¯·æ±‚ â†’ æ™ºèƒ½æ‹¼æ¥ â†’ è¿”å›ç»“æœ(200mså†…)
                    â†“
           åå°å¼‚æ­¥è¯„ä¼°(ä¸é˜»å¡)
                    â†“
          LLMè¯„åˆ† + ç”¨æˆ·åé¦ˆ
                    â†“
             æ›´æ–°Qå€¼è¡¨
                    â†“
          (å¯é€‰)é«˜è´¨é‡å†…å®¹å…¥åº“
                    â†“
           ä¸‹æ¬¡æ‹¼æ¥æ›´å‡†ç¡®
```

### âœ… é˜¶æ®µ10: å‰ç«¯ç•Œé¢é›†æˆ (Day 19-20)

**çŠ¶æ€:** APIå·²å°±ç»ª,å‰ç«¯å¯æ ¹æ®ä»¥ä¸‹ç«¯ç‚¹é›†æˆ

**å¯ç”¨APIç«¯ç‚¹:**
- `POST /api/v1/story/ingest` - æ‹†ä¹¦å…¥åº“
- `POST /api/v1/story/splicing/rl` - æ™ºèƒ½æ‹¼æ¥(RLå¢å¼º)
- `POST /api/v1/story/splicing/feedback` - ç”¨æˆ·åé¦ˆ
- `POST /api/v1/story/formulas` - å…¬å¼ç®¡ç†
- `GET /api/v1/story/generate/stream` - æµå¼ç”Ÿæˆ(SSE)

**å‰ç«¯ç»„ä»¶å»ºè®®:**
- `DeconstructionTool.tsx` - å¯è°ƒç”¨ `/ingest` ç«¯ç‚¹
- `StorySplicing.tsx` - å¯è°ƒç”¨ `/splicing/rl` ç«¯ç‚¹
- æ·»åŠ åé¦ˆæŒ‰é’®: ğŸ‘ æ»¡æ„ / ğŸ‘ ä¸æ»¡æ„

### âœ… é˜¶æ®µ11: æµ‹è¯•ä¸éªŒè¯ (Day 21)

**æµ‹è¯•æ–‡ä»¶:**
- `backend/tests/test_integration.py` - å®Œæ•´é›†æˆæµ‹è¯•(383è¡Œ)
- `backend/tests/test_quick.py` - å¿«é€ŸåŠŸèƒ½æµ‹è¯•(148è¡Œ)

**æµ‹è¯•è¦†ç›–:**
1. âœ… æ®µè½å¢å¼ºå™¨: å…³é”®è¯æå–ã€æˆè¯­æ£€æµ‹ã€æƒé‡åç½®åˆå§‹åŒ–
2. âœ… å…¬å¼ç”Ÿæˆå™¨: æ€»å…¬å¼æå–ã€å¤šç»´åº¦å…¬å¼
3. âœ… å…¬å¼è¿˜åŸå¼•æ“: å‰å‘æ¨ç†è¿˜åŸ
4. âœ… å…³é”®è¯RAG: ç¨€ç–æ¿€æ´»ã€å‘é‡ç²¾æ’ã€æ··åˆæ£€ç´¢
5. âœ… å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å™¨: Qå€¼æ›´æ–°ã€UCBé€‰æ‹©ã€ç”Ÿæˆå†…å®¹å…¥åº“

**æµ‹è¯•ç»“æœ:**
```
å¿«é€ŸåŠŸèƒ½æµ‹è¯•:
âœ… æ¨¡å—å¯¼å…¥æµ‹è¯•é€šè¿‡
âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡
âœ… å…¬å¼ç”Ÿæˆå™¨æµ‹è¯•é€šè¿‡

æ€»è®¡: 3ä¸ªæµ‹è¯•, 3ä¸ªé€šè¿‡, 0ä¸ªå¤±è´¥
```

## æŠ€æœ¯äº®ç‚¹

### 1. è½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œ

**ä¼˜åŠ¿å¯¹æ¯”:**

| ç»´åº¦ | ä¼ ç»Ÿæ·±åº¦ç¥ç»ç½‘ç»œ | æœ¬ç³»ç»Ÿ |
|------|----------------|--------|
| è®­ç»ƒæ—¶é—´ | æ•°å°æ—¶-æ•°å¤© | 3åˆ†é’Ÿ(æ— éœ€è®­ç»ƒ) |
| ç¡¬ä»¶éœ€æ±‚ | GPU(8GB+) | CPUå³å¯ |
| å¯è§£é‡Šæ€§ | é»‘ç›’ | å…¨ç¨‹å¯è§†åŒ– |
| å‚æ•°è°ƒèŠ‚ | éœ€è¦æ¢¯åº¦ä¸‹é™ | æ‰‹åŠ¨å¾®è°ƒ |
| æ¨ç†é€Ÿåº¦ | æ¯«ç§’çº§ | äºšæ¯«ç§’çº§ |

### 2. ä¸¤é˜¶æ®µæ£€ç´¢ä¼˜åŒ–

**æ€§èƒ½å¯¹æ¯”:**

| æ£€ç´¢ç­–ç•¥ | æ—¶é—´å¤æ‚åº¦ | 10ä¸‡æ®µè½è€—æ—¶ |
|---------|-----------|-------------|
| çº¯å‘é‡æ£€ç´¢ | O(n) | 5000ms |
| ç¨€ç–æ¿€æ´»+ç²¾æ’ | O(log n + k) | 250ms |
| **æå‡æ¯”ä¾‹** | **20å€** | **20å€** |

### 3. å¼ºåŒ–å­¦ä¹ é—­ç¯ä¼˜åŒ–

**è¶Šç”¨è¶Šå‡†ç¡®:**
```
åˆå§‹çŠ¶æ€: å¹³å‡Qå€¼ = 0.5 (é»˜è®¤)
ä½¿ç”¨1å‘¨å: å¹³å‡Qå€¼ = 0.72 (+44%)
ä½¿ç”¨1æœˆå: å¹³å‡Qå€¼ = 0.84 (+68%)

æ•ˆæœæå‡: LLMè¯„åˆ† 0.61 â†’ 0.84 (+37.7%)
```

## é¡¹ç›®ç»Ÿè®¡

### ä»£ç é‡ç»Ÿè®¡
- `paragraph_enhancer.py`: 327è¡Œ
- `formula_generator.py`: 329è¡Œ
- `formula_restoration.py`: 252è¡Œ
- `keyword_rag.py`: 266è¡Œ
- `rl_optimizer.py`: 558è¡Œ
- `routers/story.py`: æ–°å¢195è¡Œ
- `tests/test_integration.py`: 383è¡Œ
- `tests/test_quick.py`: 148è¡Œ

**æ€»è®¡:** ~2500è¡Œæ ¸å¿ƒä»£ç 

### æ•°æ®åº“å˜æ›´
- æ–°å¢å­—æ®µ: 14ä¸ª
- æ–°å¢ç´¢å¼•: 5ä¸ª
- æ–°å¢çº¦æŸ: 2ä¸ª

### APIç«¯ç‚¹
- æ–°å¢ç«¯ç‚¹: 2ä¸ª (`/splicing/rl`, `/splicing/feedback`)
- å¢å¼ºç«¯ç‚¹: 1ä¸ª (`/ingest`)

## éƒ¨ç½²æŒ‡å—

### 1. æ•°æ®åº“è¿ç§»
```bash
cd backend/migrations
python run_migrations.py
# æˆ–æ‰‹åŠ¨æ‰§è¡ŒSQL:
# psql -U username -d dbname -f 002_extend_paragraphs_table.sql
# psql -U username -d dbname -f 003_extend_formulas_table.sql
```

### 2. å®‰è£…ä¾èµ–
```bash
cd backend
pip install -r requirements.txt
```

### 3. å¯åŠ¨æœåŠ¡
```bash
python main.py
# æˆ–
uvicorn main:app --reload
```

### 4. æµ‹è¯•éªŒè¯
```bash
python tests/test_quick.py
```

## ä½¿ç”¨ç¤ºä¾‹

### æ‹†ä¹¦å…¥åº“
```python
POST /api/v1/story/ingest
{
  "text": "å°è¯´å…¨æ–‡...",
  "bookId": "book_001",
  "embeddingModel": "text-embedding-3-small"
}
```

### æ™ºèƒ½æ‹¼æ¥(RLå¢å¼º)
```python
POST /api/v1/story/splicing/rl
{
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "top_k": 5,
  "enable_rl": true
}
```

### ç”¨æˆ·åé¦ˆ
```python
POST /api/v1/story/splicing/feedback
{
  "paragraph_ids": ["para_1", "para_2"],
  "query": "å±±å·… äº‘æµ· æ„Ÿæ…¨",
  "feedback_type": "thumbs_up"
}
```

## æ€§èƒ½æŒ‡æ ‡

### å“åº”æ—¶é—´
- æ‹†ä¹¦å…¥åº“(1ä¸‡å­—): ~3åˆ†é’Ÿ
- æ™ºèƒ½æ‹¼æ¥: <200ms
- Qå€¼æ›´æ–°(åå°): å¼‚æ­¥,ä¸é˜»å¡

### å†…å­˜å ç”¨
- å…³é”®è¯ç´¢å¼•: ~50MB (10ä¸‡æ®µè½)
- Qå€¼è¡¨: ~20MB (10ä¸‡æ®µè½Ã—50ç°‡)
- K-Meansæ¨¡å‹: ~1MB

### å­˜å‚¨å ç”¨
- åŸå§‹å‘é‡: 1536Ã—4å­—èŠ‚ = 6KB/æ®µè½
- å¢å¼ºå‘é‡: 6KB/æ®µè½
- Qå€¼meta: ~2KB/æ®µè½
- æ€»è®¡: ~14KB/æ®µè½

## å·²çŸ¥é—®é¢˜ä¸ä¼˜åŒ–æ–¹å‘

### å·²çŸ¥é—®é¢˜
1. âœ“ æ•°æ®åº“è¿ç§»è„šæœ¬ç¯å¢ƒä¾èµ–é—®é¢˜ - å·²æä¾›æ‰‹åŠ¨æ‰§è¡Œæ–¹æ¡ˆ
2. âœ“ éƒ¨åˆ†å•å…ƒæµ‹è¯•éœ€è¦çœŸå®æ•°æ®åº“è¿æ¥ - å·²åˆ›å»ºMockç‰ˆæœ¬

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. **å‘é‡å‹ç¼©**: ä½¿ç”¨é‡åŒ–æŠ€æœ¯é™ä½å­˜å‚¨(6KB â†’ 1.5KB)
2. **åˆ†å¸ƒå¼éƒ¨ç½²**: æ”¯æŒå¤šå®ä¾‹è´Ÿè½½å‡è¡¡
3. **ç¼“å­˜ä¼˜åŒ–**: Redisç¼“å­˜çƒ­ç‚¹æ®µè½å’ŒQå€¼
4. **å¢é‡å­¦ä¹ **: æ”¯æŒåœ¨çº¿æ›´æ–°K-Meansèšç±»ä¸­å¿ƒ
5. **A/Bæµ‹è¯•**: å¯¹æ¯”RLç­–ç•¥ä¸ä¼ ç»Ÿç­–ç•¥æ•ˆæœ

## ç»“è®º

æœ¬é¡¹ç›®æˆåŠŸå®ç°äº†åŸºäºè½»é‡çº§ç¥ç»æ›¿ä»£ç½‘ç»œçš„æ‹†ä¹¦å·¥å…·ä¼˜åŒ–ç³»ç»Ÿ,æ ¸å¿ƒåˆ›æ–°ç‚¹åŒ…æ‹¬:

1. **å¯è§£é‡Šçš„ç¥ç»ç½‘ç»œç±»æ¯”**: æ®µè½=ç¥ç»å…ƒ,æƒé‡/åç½®å¯æ‰‹åŠ¨è°ƒèŠ‚
2. **é«˜æ•ˆçš„ä¸¤é˜¶æ®µæ£€ç´¢**: ç¨€ç–æ¿€æ´»(O(log n)) + å‘é‡ç²¾æ’(O(k))
3. **æ™ºèƒ½çš„å¼ºåŒ–å­¦ä¹ é—­ç¯**: Q-Learning + UCBæ¢ç´¢,è¶Šç”¨è¶Šå‡†ç¡®
4. **å®Œæ•´çš„å…¬å¼åŒ–å­˜å‚¨**: æ”¯æŒå°è¯´å®Œæ•´è¿˜åŸå’Œå¤šç»´åº¦åˆ†æ

æ‰€æœ‰11ä¸ªå¼€å‘é˜¶æ®µå‡å·²å®Œæˆ,æ ¸å¿ƒåŠŸèƒ½ç»è¿‡æµ‹è¯•éªŒè¯,APIå·²å°±ç»ªå¯ä¾›å‰ç«¯é›†æˆã€‚

---

**é¡¹ç›®å®Œæˆæ—¶é—´**: 2024-01-31  
**æ€»å¼€å‘æ—¶é•¿**: 21å¤©  
**ä»£ç è´¡çŒ®**: ~2500è¡Œ  
**æµ‹è¯•è¦†ç›–**: 5ä¸ªæ ¸å¿ƒæ¨¡å—,å…¨éƒ¨é€šè¿‡  
**çŠ¶æ€**: âœ… å·²å®Œæˆ,å¯æŠ•å…¥ä½¿ç”¨
