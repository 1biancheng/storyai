// enhancedApp.tsx
import React, { useState, useEffect, useRef, DragEvent } from 'react';
import ProjectList from './components/ProjectList';
import ChapterList from './components/ChapterList';
import Editor from './components/Editor';
import AIChatPanel from './components/AIChatPanel';
import PromptCardPanel from './components/PromptCardPanel';
import FileUploadPanel from './components/FileUploadPanel';
import { Project, Chapter, AIModel, PromptCard, Conversation, UploadFile, WritingTool } from './types';

const EnhancedApp: React.FC = () => {
  // æ¨¡æ‹Ÿæ•°æ®
  const [projects, setProjects] = useState<Project[]>([
    { id: '1', name: 'æˆ‘çš„ç¬¬ä¸€æœ¬å°è¯´', createdAt: '2023-01-01', updatedAt: '2023-01-05' },
    { id: '2', name: 'ç§‘å¹»å†’é™©æ•…äº‹', createdAt: '2023-02-15', updatedAt: '2023-02-20' },
  ]);
  
  const [chapters, setChapters] = useState<Chapter[]>([
    { id: '1', projectId: '1', title: 'ç¬¬ä¸€ç« ', content: '', createdAt: '2023-01-02', updatedAt: '2023-01-03', wordCount: 0 },
    { id: '2', projectId: '1', title: 'ç¬¬äºŒç« ', content: '', createdAt: '2023-01-04', updatedAt: '2023-01-05', wordCount: 0 },
    { id: '3', projectId: '2', title: 'ç¬¬ä¸€ç« ', content: '', createdAt: '2023-02-16', updatedAt: '2023-02-17', wordCount: 0 },
  ]);
  
  const [models, setModels] = useState<AIModel[]>([
    { id: 'kimi-k2-0905-prev', name: 'Kimi K2-0905-preview', provider: 'Moonshot AI', description: 'æœ€æ–°é¢„è§ˆç‰ˆæ¨¡å‹' },
    { id: 'gpt-4', name: 'GPT-4', provider: 'OpenAI', description: 'å¼ºå¤§çš„é€šç”¨è¯­è¨€æ¨¡å‹' },
    { id: 'claude-3', name: 'Claude 3', provider: 'Anthropic', description: 'æ³¨é‡å®‰å…¨å’Œä¼¦ç†çš„AIæ¨¡å‹' },
  ]);
  
  const [promptCards, setPromptCards] = useState<PromptCard[]>([
    { id: '1', title: 'è§’è‰²è®¾å®š', content: 'è¯·ä¸ºæˆ‘åˆ›é€ ä¸€ä¸ªæ€§æ ¼é²œæ˜çš„è§’è‰²ï¼ŒåŒ…æ‹¬å§“åã€å¤–è²Œã€èƒŒæ™¯æ•…äº‹ç­‰ã€‚', tags: ['è§’è‰²', 'è®¾å®š'], createdAt: '2023-01-01' },
    { id: '2', title: 'æƒ…èŠ‚å‘å±•', content: 'è¯·æ ¹æ®å½“å‰å‰§æƒ…ï¼Œæä¾›3ä¸ªå¯èƒ½çš„å‘å±•æ–¹å‘ï¼Œå¹¶ç®€è¦æè¿°æ¯ä¸ªæ–¹å‘çš„åæœã€‚', tags: ['æƒ…èŠ‚', 'å‘å±•'], createdAt: '2023-01-02' },
    { id: '3', title: 'ç¯å¢ƒæå†™', content: 'è¯·è¯¦ç»†æå†™ä¸€ä¸ªç¥ç§˜æ£®æ—çš„åœºæ™¯ï¼ŒåŒ…æ‹¬è§†è§‰ã€å¬è§‰ã€å—…è§‰ç­‰æ„Ÿå®˜ä½“éªŒã€‚', tags: ['ç¯å¢ƒ', 'æå†™'], createdAt: '2023-01-03' },
  ]);
  
  const [writingTools, setWritingTools] = useState<WritingTool[]>([
    { id: '1', name: 'å¤§çº²ç”Ÿæˆ', description: 'æ ¹æ®ç°æœ‰å†…å®¹ç”Ÿæˆç« èŠ‚å¤§çº²', icon: 'ğŸ“‹', category: 'åˆ›ä½œè¾…åŠ©' },
    { id: '2', name: 'è§’è‰²æ£€æŸ¥', description: 'æ£€æŸ¥è§’è‰²ä¸€è‡´æ€§å’Œé€»è¾‘æ€§', icon: 'ğŸ‘¤', category: 'è§’è‰²ç®¡ç†' },
    { id: '3', name: 'æƒ…èŠ‚åˆ†æ', description: 'åˆ†ææ•…äº‹æƒ…èŠ‚çš„è¿è´¯æ€§', icon: 'ğŸ“Š', category: 'æƒ…èŠ‚åˆ†æ' },
    { id: '4', name: 'æ¶¦è‰²å»ºè®®', description: 'æä¾›æ–‡å­—æ¶¦è‰²å’Œé£æ ¼å»ºè®®', icon: 'âœ¨', category: 'æ–‡æœ¬å¤„ç†' },
  ]);
  
  const [conversations, setConversations] = useState<Conversation[]>([
    {
      id: '1',
      projectId: '1',
      chapterId: '1',
      modelId: 'kimi-k2-0905-prev',
      memoryMode: 'short',
      messages: [
        { id: '1', role: 'user', content: 'è¯·å¸®æˆ‘ç»­å†™è¿™ä¸ªæ•…äº‹ï¼šä»–ç«™åœ¨æ‚¬å´–è¾¹ï¼Œçœ‹ç€è¿œæ–¹çš„å±±è„‰...', createdAt: '2023-01-03' },
        { id: '2', role: 'assistant', content: 'æ‰‹ï¼Œåˆçœ‹äº†çœ‹ä¸¤ä¾§æ— å°½çš„çŸ³é—¨ã€‚ä»–æ˜ç™½äº†ã€‚è¿™é‡Œä¸æ˜¯ç»ˆç‚¹ï¼Œç”šè‡³ä¸æ˜¯èµ·ç‚¹ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªå·¨å¤§çš„"é’“å°"ã€‚è€Œä»–ï¼Œæ—¢æ˜¯å’¬é’©çš„é¥µï¼Œä¹Ÿæ˜¯è¢«é’“è€…æ´¾å‡ºçš„......æ–°çš„é’“è€…ã€‚', createdAt: '2023-01-03' },
      ],
      createdAt: '2023-01-03',
      updatedAt: '2023-01-03'
    }
  ]);
  
  const [selectedProjectId, setSelectedProjectId] = useState<string | null>(null);
  const [selectedChapterId, setSelectedChapterId] = useState<string | null>(null);
  const [selectedConversationId, setSelectedConversationId] = useState<string | null>(null);
  const [isWriting, setIsWriting] = useState(false);
  const [showFileUpload, setShowFileUpload] = useState(false);
  const [showPromptCards, setShowPromptCards] = useState(false);
  const [draggedChapter, setDraggedChapter] = useState<Chapter | null>(null);
  
  // è·å–å½“å‰é€‰ä¸­çš„é¡¹ç›®ã€ç« èŠ‚å’Œå¯¹è¯
  const currentProject = projects.find(p => p.id === selectedProjectId) || null;
  const currentChapter = chapters.find(c => c.id === selectedChapterId) || null;
  const currentConversation = conversations.find(c => c.id === selectedConversationId) || null;
  
  // å¤„ç†é¡¹ç›®ç›¸å…³æ“ä½œ
  const handleSelectProject = (id: string) => {
    setSelectedProjectId(id);
    setSelectedChapterId(null);
    setSelectedConversationId(null);
  };
  
  const handleCreateProject = () => {
    const newProject: Project = {
      id: Date.now().toString(),
      name: `æ–°é¡¹ç›®${projects.length + 1}`,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    setProjects([...projects, newProject]);
    setSelectedProjectId(newProject.id);
  };
  
  const handleAddChapter = (projectId: string) => {
    const newChapter: Chapter = {
      id: Date.now().toString(),
      projectId: projectId,
      title: `æ–°ç« èŠ‚${chapters.filter(c => c.projectId === projectId).length + 1}`,
      content: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      wordCount: 0,
      linkedContents: []
    };
    setChapters([...chapters, newChapter]);
    setSelectedChapterId(newChapter.id);
    
    // åˆ›å»ºæ–°çš„å¯¹è¯
    const newConversation: Conversation = {
      id: Date.now().toString(),
      projectId: projectId,
      chapterId: newChapter.id,
      modelId: models[0].id,
      memoryMode: 'none',
      messages: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    setConversations([...conversations, newConversation]);
    setSelectedConversationId(newConversation.id);
  };
  
  // å¤„ç†ç« èŠ‚ç›¸å…³æ“ä½œ
  const handleSelectChapter = (id: string) => {
    setSelectedChapterId(id);
    
    // æŸ¥æ‰¾å¯¹åº”çš„å¯¹è¯
    const chapter = chapters.find(c => c.id === id);
    if (chapter) {
      const conversation = conversations.find(c => c.chapterId === id);
      if (conversation) {
        setSelectedConversationId(conversation.id);
      } else {
        // å¦‚æœæ²¡æœ‰å¯¹åº”å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
        const newConversation: Conversation = {
          id: Date.now().toString(),
          projectId: chapter.projectId,
          chapterId: id,
          modelId: models[0].id,
          memoryMode: 'none',
          messages: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        setConversations([...conversations, newConversation]);
        setSelectedConversationId(newConversation.id);
      }
    }
  };
  
  const handleBatchDelete = () => {
    if (selectedProjectId) {
      const updatedChapters = chapters.filter(c => c.projectId !== selectedProjectId);
      setChapters(updatedChapters);
      setSelectedChapterId(null);
    }
  };
  
  // æ‹–æ‹½æ’åºåŠŸèƒ½
  const handleDragStart = (e: DragEvent, chapter: Chapter) => {
    e.dataTransfer.setData('text/plain', chapter.id);
    setDraggedChapter(chapter);
  };
  
  const handleDragOver = (e: DragEvent) => {
    e.preventDefault();
  };
  
  const handleDrop = (e: DragEvent, targetChapterId: string) => {
    e.preventDefault();
    const sourceChapterId = e.dataTransfer.getData('text/plain');
    
    if (sourceChapterId !== targetChapterId && draggedChapter) {
      // é‡æ–°æ’åºç« èŠ‚æ•°ç»„
      const chaptersCopy = [...chapters];
      const sourceIndex = chaptersCopy.findIndex(c => c.id === sourceChapterId);
      const targetIndex = chaptersCopy.findIndex(c => c.id === targetChapterId);
      
      if (sourceIndex !== -1 && targetIndex !== -1) {
        const [removed] = chaptersCopy.splice(sourceIndex, 1);
        chaptersCopy.splice(targetIndex, 0, removed);
        setChapters(chaptersCopy);
      }
    }
    setDraggedChapter(null);
  };
  
  const handleAddFileToProject = (files: FileList) => {
    if (selectedProjectId) {
      const updatedProjects = projects.map(project => {
        if (project.id === selectedProjectId) {
          const newFiles: UploadFile[] = Array.from(files).map((file, index) => ({
            id: `file-${Date.now()}-${index}`,
            name: file.name,
            size: file.size,
            type: file.type,
            uploadedAt: new Date().toISOString()
          }));
          
          return {
            ...project,
            uploadFiles: [...(project.uploadFiles || []), ...newFiles],
            updatedAt: new Date().toISOString()
          };
        }
        return project;
      });
      setProjects(updatedProjects);
    }
  };
  
  const handleAddPromptCard = (card: PromptCard) => {
    if (selectedProjectId) {
      const newCard: PromptCard = {
        ...card,
        id: Date.now().toString(),
        createdAt: new Date().toISOString(),
        projectId: selectedProjectId
      };
      setPromptCards([...promptCards, newCard]);
    }
  };
  
  const handleLinkContent = (content: LinkedContent) => {
    if (currentChapter) {
      const updatedChapter = {
        ...currentChapter,
        linkedContents: [...(currentChapter.linkedContents || []), content],
        updatedAt: new Date().toISOString()
      };
      const updatedChapters = chapters.map(c => 
        c.id === currentChapter.id ? updatedChapter : c
      );
      setChapters(updatedChapters);
    }
  };
  
  // å¤„ç†ç¼–è¾‘å™¨ç›¸å…³æ“ä½œ
  const handleSaveContent = (content: string) => {
    if (currentChapter) {
      const updatedChapter = {
        ...currentChapter,
        content,
        updatedAt: new Date().toISOString(),
        wordCount: content.length
      };
      const updatedChapters = chapters.map(c => 
        c.id === currentChapter.id ? updatedChapter : c
      );
      setChapters(updatedChapters);
    }
  };
  
  const handleContinueWriting = (instruction: string) => {
    setIsWriting(true);
    // æ¨¡æ‹ŸAIç”Ÿæˆå†…å®¹
    setTimeout(() => {
      if (currentChapter) {
        const newContent = currentChapter.content + '\n\n' + 'AIç”Ÿæˆçš„å†…å®¹ï¼šè¿™æ˜¯ç”±AIç»§ç»­å†™çš„å†…å®¹ï¼Œç”¨äºæ¼”ç¤ºåŠŸèƒ½ã€‚';
        const updatedChapter = {
          ...currentChapter,
          content: newContent,
          updatedAt: new Date().toISOString(),
          wordCount: newContent.length
        };
        const updatedChapters = chapters.map(c => 
          c.id === currentChapter.id ? updatedChapter : c
        );
        setChapters(updatedChapters);
      }
      setIsWriting(false);
    }, 2000);
  };
  
  const handleStopWriting = () => {
    setIsWriting(false);
  };
  
  // å¤„ç†å¯¹è¯ç›¸å…³æ“ä½œ
  const handleNewConversation = () => {
    if (selectedProjectId && selectedChapterId) {
      const newConversation: Conversation = {
        id: Date.now().toString(),
        projectId: selectedProjectId,
        chapterId: selectedChapterId,
        modelId: models[0].id,
        memoryMode: 'none',
        messages: [],
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
      setConversations([...conversations, newConversation]);
      setSelectedConversationId(newConversation.id);
    }
  };
  
  const handleSendMessage = (message: string) => {
    if (currentConversation && selectedChapterId) {
      const newMessage: Message = {
        id: Date.now().toString(),
        role: 'user',
        content: message,
        createdAt: new Date().toISOString()
      };
      
      const updatedMessages = [...currentConversation.messages, newMessage];
      const updatedConversation = {
        ...currentConversation,
        messages: updatedMessages,
        updatedAt: new Date().toISOString()
      };
      
      const updatedConversations = conversations.map(c => 
        c.id === currentConversation.id ? updatedConversation : c
      );
      setConversations(updatedConversations);
      
      // æ¨¡æ‹ŸAIå›å¤
      setTimeout(() => {
        const aiResponse: Message = {
          id: Date.now().toString(),
          role: 'assistant',
          content: 'è¿™æ˜¯AIçš„å›å¤å†…å®¹ï¼Œç”¨äºæ¼”ç¤ºåŠŸèƒ½ã€‚',
          createdAt: new Date().toISOString()
        };
        
        const updatedMessagesWithAI = [...updatedMessages, aiResponse];
        const updatedConversationWithAI = {
          ...updatedConversation,
          messages: updatedMessagesWithAI,
          updatedAt: new Date().toISOString()
        };
        
        const updatedConversationsWithAI = conversations.map(c => 
          c.id === currentConversation.id ? updatedConversationWithAI : c
        );
        setConversations(updatedConversationsWithAI);
      }, 1000);
    }
  };
  
  const handleModelChange = (modelId: string) => {
    if (currentConversation) {
      const updatedConversation = {
        ...currentConversation,
        modelId,
        updatedAt: new Date().toISOString()
      };
      const updatedConversations = conversations.map(c => 
        c.id === currentConversation.id ? updatedConversation : c
      );
      setConversations(updatedConversations);
    }
  };
  
  const handleMemoryModeChange = (mode: 'none' | 'short' | 'long') => {
    if (currentConversation) {
      const updatedConversation = {
        ...currentConversation,
        memoryMode: mode,
        updatedAt: new Date().toISOString()
      };
      const updatedConversations = conversations.map(c => 
        c.id === currentConversation.id ? updatedConversation : c
      );
      setConversations(updatedConversations);
    }
  };
  
  return (
    <div className="app-container">
      {/* å·¦ä¾§é¡¹ç›®åˆ—è¡¨ */}
      <div className="sidebar-left">
        <ProjectList
          projects={projects}
          selectedProjectId={selectedProjectId}
          onSelectProject={handleSelectProject}
          onCreateProject={handleCreateProject}
          onAddChapter={handleAddChapter}
          onShowFileUpload={() => setShowFileUpload(true)}
          onShowPromptCards={() => setShowPromptCards(true)}
        />
        
        {selectedProjectId && (
          <ChapterList
            chapters={chapters.filter(c => c.projectId === selectedProjectId)}
            selectedChapterId={selectedChapterId}
            onSelectChapter={handleSelectChapter}
            onBatchDelete={handleBatchDelete}
            onDragStart={handleDragStart}
            onDragOver={handleDragOver}
            onDrop={handleDrop}
          />
        )}
      </div>
      
      {/* ä¸­é—´ç¼–è¾‘åŒº */}
      <div className="main-content">
        <Editor
          chapter={currentChapter}
          onSave={handleSaveContent}
          onContinueWriting={handleContinueWriting}
          onStopWriting={handleStopWriting}
          isWriting={isWriting}
          writingTools={writingTools}
          onApplyTool={(toolId) => {
            console.log('åº”ç”¨å·¥å…·:', toolId);
          }}
        />
      </div>
      
      {/* å³ä¾§AIå¯¹è¯åŒº */}
      <div className="sidebar-right">
        <AIChatPanel
          conversation={currentConversation}
          models={models}
          promptCards={promptCards}
          onSendMessage={handleSendMessage}
          onNewConversation={handleNewConversation}
          onModelChange={handleModelChange}
          onMemoryModeChange={handleMemoryModeChange}
          onLinkContent={handleLinkContent}
          onAddPromptCard={() => setShowPromptCards(true)}
        />
      </div>
      
      {/* æ–‡ä»¶ä¸Šä¼ å¼¹çª— */}
      {showFileUpload && (
        <FileUploadPanel
          onClose={() => setShowFileUpload(false)}
          onUpload={handleAddFileToProject}
        />
      )}
      
      {/* æç¤ºè¯å¡ç‰‡å¼¹çª— */}
      {showPromptCards && (
        <PromptCardPanel
          promptCards={promptCards}
          onClose={() => setShowPromptCards(false)}
          onSelectCard={(card) => {
            console.log('é€‰æ‹©æç¤ºè¯å¡ç‰‡:', card);
            setShowPromptCards(false);
          }}
          onAddCard={(card) => {
            handleAddPromptCard(card);
            setShowPromptCards(false);
          }}
        />
      )}
    </div>
  );
};

export default EnhancedApp;
