// enhancedEditor.tsx
import React, { useState, useEffect, useRef } from 'react';
import { Chapter, WritingTool } from '../types';

interface EnhancedEditorProps {
  chapter: Chapter | null;
  onSave: (content: string) => void;
  onContinueWriting: (instruction: string) => void;
  onStopWriting: () => void;
  isWriting: boolean;
  writingTools: WritingTool[];
  onApplyTool: (toolId: string) => void;
}

const EnhancedEditor: React.FC<EnhancedEditorProps> = ({
  chapter,
  onSave,
  onContinueWriting,
  onStopWriting,
  isWriting,
  writingTools,
  onApplyTool
}) => {
  const [content, setContent] = useState<string>('');
  const [fontFamily, setFontFamily] = useState<string>('æ ‡å‡†');
  const [fontSize, setFontSize] = useState<number>(16);
  const [prompt, setPrompt] = useState<string>('æ— æç¤ºè¯');
  const [showTools, setShowTools] = useState<boolean>(false);
  const editorRef = useRef<HTMLTextAreaElement>(null);

  useEffect(() => {
    if (chapter) {
      setContent(chapter.content);
    }
  }, [chapter]);

  const handleContentChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    setContent(e.target.value);
    // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
  };

  const handleSave = () => {
    onSave(content);
  };

  const handleContinueWriting = () => {
    if (editorRef.current) {
      const selectionStart = editorRef.current.selectionStart;
      const selectionEnd = editorRef.current.selectionEnd;
      const instruction = prompt === 'æ— æç¤ºè¯' ? '' : prompt;
      
      onContinueWriting(instruction);
    }
  };

  const wordCount = content.length;
  const readingTime = Math.ceil(wordCount / 200); // å‡è®¾æ¯åˆ†é’Ÿ200å­—

  return (
    <div className="editor">
      {chapter ? (
        <>
          <div className="editor-header">
            <h2>{chapter.title}</h2>
            <div className="editor-controls">
              <div className="stats">
                <span>æ€»å­—æ•°: {wordCount}</span>
                <span>é¢„è®¡é˜…è¯»: {readingTime}åˆ†é’Ÿ</span>
                <span className="links-count">
                  é“¾æ¥å†…å®¹: {chapter.linkedContents?.length || 0}
                </span>
                <select 
                  value={fontFamily} 
                  onChange={(e) => setFontFamily(e.target.value)}
                >
                  <option value="æ ‡å‡†">æ ‡å‡†</option>
                  <option value="å®‹ä½“">å®‹ä½“</option>
                  <option value="é»‘ä½“">é»‘ä½“</option>
                  <option value="æ¥·ä½“">æ¥·ä½“</option>
                </select>
                <select 
                  value={fontSize} 
                  onChange={(e) => setFontSize(parseInt(e.target.value))}
                >
                  <option value="14">å°</option>
                  <option value="16">ä¸­</option>
                  <option value="18">å¤§</option>
                  <option value="20">è¶…å¤§</option>
                </select>
                <select 
                  value={prompt} 
                  onChange={(e) => setPrompt(e.target.value)}
                >
                  <option value="æ— æç¤ºè¯">æ— æç¤ºè¯</option>
                  <option value="ç»­å†™æƒ…èŠ‚">ç»­å†™æƒ…èŠ‚</option>
                  <option value="æå†™ç¯å¢ƒ">æå†™ç¯å¢ƒ</option>
                  <option value="åˆ»ç”»äººç‰©">åˆ»ç”»äººç‰©</option>
                  <option value="å¯¹è¯ç”Ÿæˆ">å¯¹è¯ç”Ÿæˆ</option>
                  <option value="æƒ…èŠ‚åˆ†æ">æƒ…èŠ‚åˆ†æ</option>
                </select>
              </div>
              
              <div className="tool-buttons">
                <button 
                  className={`btn ${showTools ? 'btn-primary' : 'btn-secondary'}`}
                  onClick={() => setShowTools(!showTools)}
                >
                  ğŸ› ï¸ å·¥å…·ç®± {showTools ? 'â–²' : 'â–¼'}
                </button>
                <button className="btn btn-save" onClick={handleSave}>
                  ä¿å­˜
                </button>
              </div>
            </div>
          </div>
          
          {showTools && (
            <div className="tools-panel">
              <h3>å†™ä½œå·¥å…·</h3>
              <div className="tools-grid">
                {writingTools.map(tool => (
                  <div 
                    key={tool.id} 
                    className="tool-item"
                    onClick={() => onApplyTool(tool.id)}
                  >
                    <div className="tool-icon">{tool.icon}</div>
                    <div className="tool-info">
                      <div className="tool-name">{tool.name}</div>
                      <div className="tool-desc">{tool.description}</div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <textarea
            ref={editorRef}
            value={content}
            onChange={handleContentChange}
            className="editor-content"
            style={{ fontSize: `${fontSize}px` }}
            placeholder="å¼€å§‹åˆ›ä½œ..."
          />
          
          <div className="writing-tools">
            <div className="tool-info">
              <div className="info-icon">ğŸ’¡</div>
              <div className="info-text">
                <strong>ç»­å†™åŠŸèƒ½ä½¿ç”¨è¯´æ˜ï¼š</strong>
                <ol>
                  <li>è¾“å…¥ user: ä½ çš„æŒ‡ä»¤</li>
                  <li>ç‚¹å‡»ã€Œç»­å†™ã€ï¼ŒAIä¼šæµå¼è¾“å‡ºï¼š</li>
                  <li>-> æ¨¡å‹å›ç­”å†…å®¹...</li>
                  <li><-</li>
                  <li>3. ç‚¹å‡»ã€Œæš‚åœã€å¯ä»¥åœæ­¢è¾“å‡º</li>
                </ol>
              </div>
            </div>
            
            <div className="tool-buttons">
              <button 
                className="btn btn-continue" 
                onClick={handleContinueWriting}
                disabled={isWriting}
              >
                {isWriting ? 'æ­£åœ¨ç”Ÿæˆ...' : 'ç»­å†™'}
              </button>
              <button 
                className="btn btn-stop" 
                onClick={onStopWriting}
                disabled={!isWriting}
              >
                æš‚åœ
              </button>
            </div>
          </div>
        </>
      ) : (
        <div className="no-chapter-selected">
          <h3>å¼€å§‹åˆ›ä½œä¹‹æ—…</h3>
          <p>è¯·é€‰æ‹©ä¸€ä¸ªç« èŠ‚å¼€å§‹å†™ä½œï¼Œæˆ–è€…åˆ›å»ºæ–°çš„é¡¹ç›®å’Œç« èŠ‚ã€‚</p>
          <div className="quick-actions">
            <button className="btn btn-primary" onClick={() => {}}>
              å¿«é€Ÿåˆ›å»ºæ–°é¡¹ç›®
            </button>
            <button className="btn btn-secondary" onClick={() => {}}>
              å¯¼å…¥æ–‡æ¡£
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

export default EnhancedEditor;
